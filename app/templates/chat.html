{% extends "base.html" %}

{% block content %}
<div class="card chat-container" style="max-width: 800px; margin: 20px auto;">
    <h2 style="color: var(--ng-green-dark); margin-bottom: 5px;">TaxBuddy Strategist</h2>
    <p style="font-size: 0.85rem; color: #777; margin-bottom: 20px;">2026 Nigerian Tax Act Optimization</p>
    
    <div id="chat-window" style="height: 500px; overflow-y: auto; border: 1px solid #eee; padding: 25px; background: #fafafa; border-radius: 12px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 15px; font-family: 'Inter', sans-serif;">
        <div class="bot-msg" style="background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #2e7d32; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <strong>TaxBuddy:</strong> Good day. How are we optimizing your finances today?
        </div>
    </div>

    <div id="file-preview" style="font-size: 0.8rem; color: #2e7d32; margin-left: 50px; margin-bottom: 5px; font-weight: bold;"></div>

    <form id="chat-form" style="display: flex; gap: 12px; align-items: center; background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <label for="file-upload" style="cursor: pointer; font-size: 1.4rem; padding: 5px; color: #666;" title="Upload Receipt or PDF">
            ðŸ“Ž
        </label>
        <input type="file" id="file-upload" style="display: none;" accept="image/*,application/pdf">
        
        <input type="text" id="user-input" placeholder="Enter transaction or query..." style="flex-grow: 1; padding: 12px; border: none; outline: none; font-size: 1rem;">
        
        <button type="submit" style="background: #2e7d32; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">Analyze</button>
    </form>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const fileInput = document.getElementById('file-upload');
    const filePreview = document.getElementById('file-preview');
    
    let chatHistory = [];

    fileInput.addEventListener('change', () => {
        filePreview.innerText = fileInput.files.length > 0 ? `ðŸ“„ ${fileInput.files[0].name}` : '';
    });

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = userInput.value.trim();
        const file = fileInput.files[0];
        if (!message && !file) return;

        // UI Update
        appendMessage('user', message + (file ? `<br><small><i>Attached: ${file.name}</i></small>` : ''));
        
        const formData = new FormData();
        formData.append('message', message || "Analyze attached document.");
        formData.append('history', JSON.stringify(chatHistory));
        if (file) formData.append('file', file);

        userInput.value = '';
        fileInput.value = '';
        filePreview.innerText = '';
        const loadingId = appendLoading();

        try {
            const response = await fetch('/api/chat', { method: 'POST', body: formData });
            const data = await response.json();
            removeLoading(loadingId);

            if (response.ok) {
                // Use 'marked' library for professional formatting
                const htmlResponse = marked.parse(data.answer);
                appendMessage('model', htmlResponse);
                
                // Update History
                chatHistory.push({ role: 'user', parts: message || "[File]" });
                chatHistory.push({ role: 'model', parts: data.answer });
            } else {
                appendMessage('model', "The system is currently unavailable. Please try again shortly.");
            }
        } catch (err) {
            removeLoading(loadingId);
            appendMessage('model', "Connection error. Please check your network.");
        }
    });

    function appendMessage(role, content) {
        const msgDiv = document.createElement('div');
        msgDiv.className = role === 'user' ? 'user-msg' : 'bot-msg';
        msgDiv.style.maxWidth = "85%";
        msgDiv.style.padding = "15px";
        msgDiv.style.borderRadius = "10px";
        msgDiv.style.alignSelf = role === 'user' ? "flex-end" : "flex-start";
        msgDiv.style.background = role === 'user' ? "#e3f2fd" : "#fff";
        if (role !== 'user') msgDiv.style.borderLeft = "4px solid #2e7d32";
        
        msgDiv.innerHTML = `<strong>${role === 'user' ? 'You' : 'TaxBuddy'}:</strong><br>${content}`;
        chatWindow.appendChild(msgDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function appendLoading() {
        const id = 'loading-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.style.fontSize = "0.8rem";
        div.style.color = "#999";
        div.innerText = "Analyzing tax implications...";
        chatWindow.appendChild(div);
        return id;
    }

    function removeLoading(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }
</script>
{% endblock %}